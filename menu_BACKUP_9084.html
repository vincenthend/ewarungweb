<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E-Warung</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
</head>
<body>
<div class="container">
    <div class="header">
        E-Warung
    </div>
    <div class="content" id="menu-list">
        <div class="resto-banner">
            
        </div>

        <div class="card-content">
            <div class="content-label">Menu</div>
            <div class="content-box" id="menu">
                <form id="orderForm" method="GET" action="https://script.google.com/macros/s/AKfycbzfGm-nwmfVcwktmtFGNY6fi2rBthYV_RuqUvVA7X1z/dev?route=addOrder">
                </form>
            </div>
        </div>
    </div>
	<div class="block-adder"></div>

    <div class="bottom-panel">
        <div class="order-total">
            <div class="total-label">
                Total
            </div>
            <div class="total-number">
                0
            </div>
        </div>
        <div class="order-button" onclick="showConfirm();">
            Pesan
        </div>
    </div>
</div>


<div class="notification" id="notification-confirm">
    <div class="notification-box">
        <div class="notification-section" id="alergen">
            <div class="notification-header">
                Alergen
            </div>
            <div class="notification-content">
                Mengandung telur
            </div>
        </div>

        <div class="notification-section" id="total">
            <div class="notification-header">
                Total Pesanan
            </div>
            <div class="notification-content">
                <div class="amount-box">
                    <div class="label">Pesanan</div>
                    <div class="amount" id="am-pesanan">16.000</div>
                </div>
                <div class="amount-box">
                    <div class="label">Biaya Antar</div>
                    <div class="amount" id="am-antar">3.000</div>
                </div>
                <hr>
                <div class="amount-box">
                    <div class="label">Total</div>
                    <div class="amount" id="am-total">16.000</div>
                </div>
            </div>
        </div>

        <div class="notification-section" id="lokasi">
            <div class="notification-header">
                Lokasi Pengantaran
            </div>
            <div class="notification-content">
                <input type="text" name="lokasi-antar" id="lokasi-antar"> <span id="edit"></span>
            </div>
        </div>

        <button type="button" onclick="sendform();">Pesan</button>
    </div>
</div>
<div class="notification" id="notification-token">
    <div class="notification-box">
        <div class="notification-picture" >
            <!-- Gambar -->
        </div>

        <div class="notification-text">
            You got a reward token!
        </div>

        <button type="button" onClick="toOrder()">OK</button>
    </div>
</div>
<script type="text/javascript">

var idOrder = 0;
var menu_count = 0;

function toOrder(){
	console.log(idOrder);
	window.location.replace('order_sending.html?id='+idOrder);
}

function displayToken(id){
    document.getElementById("notification-confirm").style = "display: hidden;";
    document.getElementById("notification-token").style = "display: flex;";
	idOrder = id;
}

function getSearchParameters() {
      var prmstr = window.location.search.substr(1);
      return prmstr != null && prmstr != "" ? transformToAssocArray(prmstr) : {};
}

function transformToAssocArray( prmstr ) {
    var params = {};
    var prmarr = prmstr.split("&");
    for ( var i = 0; i < prmarr.length; i++) {
        var tmparr = prmarr[i].split("=");
        params[tmparr[0]] = tmparr[1];
    }
    return params;
}
var currentRestoJSON;
var params = getSearchParameters();
var xmlhttp;
if (window.XMLHttpRequest){
    xmlhttp = new XMLHttpRequest();
} else {
    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
}
xmlhttp.open("GET","https://script.google.com/macros/s/AKfycbzfGm-nwmfVcwktmtFGNY6fi2rBthYV_RuqUvVA7X1z/dev?route=getWarungbyId&id=" + params.id,true);
xmlhttp.send();
xmlhttp.onreadystatechange = function () {
    if (this.readyState === 4 && this.status === 200){
        currentRestoJSON = JSON.parse(this.response);
        var banner = document.getElementsByClassName("resto-banner")[0];
        var pic = document.createElement("div");
        pic.className = "resto-banner-pic";
        banner.appendChild(pic);
        var bannerInfo = document.createElement("div");
        bannerInfo.className = "resto-banner-info";
        banner.appendChild(bannerInfo);
        var bannerName = document.createElement("div");
        bannerName.className = "resto-name";
        bannerName.innerHTML = currentRestoJSON.result.restoName;
        bannerInfo.appendChild(bannerName);
        var bannerAdd = document.createElement("div");
        bannerAdd.className = "resto-address";
        bannerAdd.innerHTML = currentRestoJSON.result.restoLoc;
        bannerInfo.appendChild(bannerAdd);
    }
};

// Ambil data menu
var xmlhttpX;
if (window.XMLHttpRequest){
    xmlhttpX = new XMLHttpRequest();
} else {
    xmlhttpX = new ActiveXObject("Microsoft.XMLHTTP");
}
xmlhttpX.open("GET","https://script.google.com/macros/s/AKfycbzfGm-nwmfVcwktmtFGNY6fi2rBthYV_RuqUvVA7X1z/dev?route=getMenu&id=" + params.id,true);
xmlhttpX.send();
xmlhttpX.onreadystatechange = function () {
    if (this.readyState === 4 && this.status === 200){
        console.log(this.response);
        var currentMenuJSON = JSON.parse(this.response);
        // ambil id menu
        var formMenu = document.getElementById("orderForm");
        var currentMenuJSONRes = currentMenuJSON.result
		menu_count = currentMenuJSONRes.length;
        for (var menu in currentMenuJSONRes){
            var menucard = document.createElement("div");
            menucard.className = "menu-card-small";
            formMenu.appendChild(menucard);
            var menupic = document.createElement("div");
            menupic.className = "menu-pic";
            menucard.appendChild(menupic);
            var menuname = document.createElement("div");
            menuname.className = "menu-name";
            menuname.innerHTML = currentMenuJSONRes[menu].nama;
            menucard.appendChild(menuname);
            var menuprice = document.createElement("div");
            menuprice.className = "menu-price";
            menuprice.id = "price-" + currentMenuJSONRes[menu].nama;
            menuprice.innerHTML = currentMenuJSONRes[menu].harga;
            menucard.appendChild(menuprice);
            var menuquantity = document.createElement("div");
            menuquantity.className = "menu-quantity";
            menucard.appendChild(menuquantity);
            var btnmin = document.createElement("button");
            btnmin.className = "qty-button";
            btnmin.type="button";
            btnmin.innerHTML = "-";
            menuquantity.appendChild(btnmin);
            var inp = document.createElement("input");
            inp.className = "qty-menu";
            inp.name = currentMenuJSONRes[menu].nama;
            inp.type="text";
            inp.value = 0;
            menuquantity.appendChild(inp);
            var btnplus = document.createElement("button");
            btnplus.className = "qty-button";
            btnplus.type="button";
            btnplus.innerHTML = "+";
            menuquantity.appendChild(btnplus);
        }
		updateLength();
    }
	button = document.getElementsByClassName('qty-button');
	field = document.getElementsByClassName('qty-menu');
    for(i=0; i<button.length; i++) {
        button[i].addEventListener('click', calculateSum);
    }
	for(i=0; i<field.length; i++) {
        field[i].addEventListener('change', calculateSum);
    }
};

function updateLength(){
	var elm = document.getElementsByClassName("block-adder")[0];
	
	var size = menu_count <= 6 ? 0: Math.floor(menu_count/3)*20;
	
	elm.style.cssText = "height: "+size+"%; width:100%;";
}

var form = document.getElementById("orderForm");

function calculateSum() {
    var sum = 0;
    for (var i = 0, ii = form.length; i < ii; ++i) {
    var data = {};
    var input = form[i];
    if (input.name && (input.value > 0)) {
      sum = sum + (input.value * (document.getElementById("price-" + input.name).innerHTML));
    }
    document.getElementsByClassName("total-number")[0].innerHTML = sum;
    document.getElementById("am-pesanan").innerHTML = sum;
    document.getElementById("am-total").innerHTML = sum + 3000;
	console.log("asd");
    // push ke json
  }
  return sum;
}

var retval = {};

function showConfirm() {
    calculateSum();
    document.getElementById("notification-confirm").style = "display: flex;";
}

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
}

function showPosition(position) {
    retval.delivery_lat =  position.coords.latitude;
    retval.delivery_long = position.coords.longitude;
}
getLocation();
function sendform() {
  // collect the form data while iterating over the inputs
  
  retval.warung_id = params.id;
  retval.delivery_location = document.getElementById("lokasi-antar").value;
    getLocation();
  retval.total = calculateSum() + 3000;
    retval.item = [];
  for (var i = 0, ii = form.length; i < ii; ++i) {
    var data = {};
    var input = form[i];
    if (input.name && (input.value > 0)) {
      data["item_name"] = input.name;
      data["qty"] = input.value;
      retval.item.push(data);
    }
    
    // push ke json
  }
  console.log(JSON.stringify(retval));

  var xhr;
    if (window.XMLHttpRequest){
        xhr = new XMLHttpRequest();
    } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
    }
    var sendreq = "https://script.google.com/macros/s/AKfycbzfGm-nwmfVcwktmtFGNY6fi2rBthYV_RuqUvVA7X1z/dev?route=addOrder&order=" + JSON.stringify(retval);
    xhr.open("GET",sendreq,true);
    //xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
    //console.log(sendreq);
    xhr.send();
    xhr.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200){
<<<<<<< HEAD
			console.log(this.response);
			var jsonObj = JSON.parse(this.response);
			displayToken(jsonObj.result);
			
=======
			var temp = JSON.parse(this.response);
            idOrder = temp.result;
			console.log(idOrder);
			displayToken();
>>>>>>> 54c2104a60812e5feeabbde96ab159cceac9bb54
        }
    };
  

};

</script>
</body>
</html>